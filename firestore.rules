rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to get user data
    function getUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }

    // Helper: current user's societyId
    function userSociety() {
      return getUserData(request.auth.uid).societyId;
    }
    // Users: authentication and role-based access control
    match /users/{userId} {
      allow create: if request.auth != null && (
                     // Users may create their own user doc (registration flow)
                     (request.auth.uid == userId
                       && request.resource.data.keys().hasAll(['email','role','uid','societyId'])
                       && request.resource.data.uid == request.auth.uid
                       && request.resource.data.role in ['student','homeroom','admin']
                       && request.resource.data.societyId == request.resource.data.societyId)
                     ||
                     // Admins may create users for their society
                     (isAdmin()
                       && request.resource.data.keys().hasAll(['email','role','uid','societyId'])
                       && request.resource.data.role in ['student','homeroom','admin']
                       && request.resource.data.societyId == userSociety())
                   );

      allow read: if request.auth != null && (
                   request.auth.uid == userId ||
                   (isAdmin() && resource.data.societyId == userSociety())
                 );

      allow update: if request.auth != null && (
                     // Users may update a small set of their own fields
                     (request.auth.uid == userId
                        && request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['displayName'])
                        )
                     ||
                     // Admins may update users within their society
                     (isAdmin()
                        && resource.data.societyId == userSociety()
                        && request.resource.data.diff(resource.data).affectedKeys()
                           .hasOnly(['email','role','studentId','displayName','societyId'])
                     )
                   );

      allow delete: if request.auth != null && isAdmin() && resource.data.societyId == userSociety();
    }

    // Surveys: require authentication and validate fields
    match /surveys/{surveyId} {
      allow create: if request.auth != null
                   && request.resource.data.userId == request.auth.uid
                   && request.resource.data.keys().hasAll(['fullName', 'contact', 'rating', 'datetime', 'userId', 'latitude', 'longitude'])
                   && request.resource.data.rating in ['1','2','3','4','5']
                   && request.resource.data.latitude is number
                   && request.resource.data.longitude is number
                   && request.resource.data.latitude >= -90 && request.resource.data.latitude <= 90
                   && request.resource.data.longitude >= -180 && request.resource.data.longitude <= 180
                   && request.resource.data.keys().hasOnly(['fullName','contact','rating','comments','datetime','submittedAt','userId','latitude','longitude','imageUrl','imageData']);

      allow read: if request.auth != null && (
                    resource.data.userId == request.auth.uid ||
                    isAdmin()
                  );

      allow update: if request.auth != null && 
                     resource.data.userId == request.auth.uid;

      allow delete: if request.auth != null && (
                     resource.data.userId == request.auth.uid ||
                     isAdmin()
                   );
    }

    // Homerooms: created and managed by admins
    match /homerooms/{homeroomId} {
      allow create: if request.auth != null
                     && isAdmin()
                     && request.resource.data.keys().hasAll(['name','createdAt','adminUid'])
                     && request.resource.data.adminUid == request.auth.uid
                     && request.resource.data.keys().hasOnly(['name','code','createdAt','adminUid']);

      allow read: if request.auth != null && (
                    isAdmin() ||
                    resource.data.adminUid == request.auth.uid
                  );

      allow update: if request.auth != null &&
                     isAdmin() &&
                     request.resource.data.adminUid == resource.data.adminUid;

      allow delete: if request.auth != null && isAdmin();
    }

    // Fees: admin-managed contribution fees
    match /fees/{feeId} {
      allow create: if request.auth != null
                     && isAdmin()
                     && request.resource.data.keys().hasAll(['description','amount','createdAt','createdBy','societyId'])
                     && request.resource.data.createdBy == request.auth.uid
                     && request.resource.data.societyId == userSociety()
                     && request.resource.data.amount is number
                     && request.resource.data.amount > 0
                     && request.resource.data.keys().hasOnly(['description','amount','createdAt','createdBy','societyId']);

      // Admins and authorized users may read fees for their society only
      allow read: if request.auth != null && resource.data.societyId == userSociety();

      allow update: if request.auth != null
                     && isAdmin()
                     && resource.data.societyId == userSociety()
                     && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['description','amount'])
                     && request.resource.data.amount is number
                     && request.resource.data.amount > 0
                     && request.resource.data.createdBy == resource.data.createdBy;

      allow delete: if request.auth != null && isAdmin() && resource.data.societyId == userSociety();

      // List (query) must include a filter on societyId to prevent cross-society listing
      allow list: if request.auth != null
                   && request.query.where('societyId','==', userSociety());
    }

    // Payments: payment tracking with granular access control
    match /payments/{paymentId} {
      allow create: if request.auth != null
                     && isAdmin()
                     && request.resource.data.keys().hasAll(['studentId','feeId','status','createdAt','societyId'])
                     && request.resource.data.status in ['paid','unpaid']
                     && request.resource.data.societyId == userSociety()
                     // referenced fee must belong to same society
                     && get(/databases/$(database)/documents/fees/$(request.resource.data.feeId)).data.societyId == userSociety()
                     // referenced student must belong to same society
                     && get(/databases/$(database)/documents/students/$(request.resource.data.studentId)).data.societyId == userSociety()
                     && request.resource.data.keys().hasOnly(['studentId','feeId','status','createdAt','paidAt','paidBy','notes','societyId']);

      allow read: if request.auth != null && (
                    // Admins can read payments for their society
                    (isAdmin() && resource.data.societyId == userSociety()) ||
                    // Students can read their own payments; ensure same society
                    (resource.data.studentId == getUserData(request.auth.uid).studentId
                       && resource.data.societyId == userSociety())
                  );

      allow update: if request.auth != null
                     && isAdmin()
                     && resource.data.societyId == userSociety()
                     && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status','paidAt','paidBy','notes'])
                     && request.resource.data.status in ['paid','unpaid']
                     && request.resource.data.studentId == resource.data.studentId
                     && request.resource.data.feeId == resource.data.feeId
                     && request.resource.data.societyId == resource.data.societyId;

      allow delete: if request.auth != null && isAdmin() && resource.data.societyId == userSociety();

      // list must specify the societyId filter
      allow list: if request.auth != null
                   && request.query.where('societyId','==', userSociety());
    }

    // Students: student roster data (bulk imported, read-only or admin-managed)
    match /students/{studentId} {
      allow create: if request.auth != null
                     && isAdmin()
                     && request.resource.data.keys().hasAll(['studentId','createdAt','createdBy','societyId'])
                     && request.resource.data.studentId == studentId
                     && request.resource.data.createdBy == request.auth.uid
                     && request.resource.data.societyId == userSociety()
                     && request.resource.data.keys().hasOnly(['studentId','societyId','firstName','lastName','createdAt','createdBy','programId','collegeId','yearLevelId','sectionId']);

      allow read: if request.auth != null && (
                    (isAdmin() && resource.data.societyId == userSociety()) ||
                    (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.studentId == studentId
                       && resource.data.societyId == userSociety())
                  );

      allow update: if request.auth != null
                     && isAdmin()
                     && resource.data.societyId == userSociety()
                     && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['firstName','lastName','programId','collegeId','yearLevelId','sectionId'])
                     && request.resource.data.studentId == resource.data.studentId
                     && request.resource.data.createdBy == resource.data.createdBy;

      allow delete: if request.auth != null && isAdmin() && resource.data.societyId == userSociety();

      // list (query) must include a society filter matching the requesting user's society
      allow list: if request.auth != null
                   && request.query.where('societyId','==', userSociety());
    }
  }
}
