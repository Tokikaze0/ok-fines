rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---
    
    // Check if the authenticated user is an admin
    function isAdmin() {
      return request.auth != null
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Get user data for society checks
    function getUserData(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data;
    }

    // Check if the authenticated user is a homeroom officer
    function isHomeroom() {
      return request.auth != null
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'homeroom';
    }

    // --- COLLECTIONS ---

    // USERS: Profiles for Admin, Student, and Homeroom accounts
    match /users/{userId} {
      // 1. Allow users to read their own profile
      // 2. Allow Admins to read all profiles
      // 3. Allow public read of 'student' profiles (for ID lookup)
      // 4. Allow public read of 'admin' profiles (to check for existing society admins during registration)
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin() || isHomeroom())
                  || (resource.data.role == 'student')
                  || (resource.data.role == 'admin');

      // Create: 
      // 1. Self-registration for the first Admin (setup)
      // 2. Admins creating other users (Homeroom/Student accounts)
      allow create: if (request.auth != null && request.auth.uid == userId && request.resource.data.role == 'admin')
                    || (isAdmin());

      // Update:
      // 1. Admins can update any user (roles, society, etc.)
      // 2. Users can update their own basic info (displayName)
      allow update: if isAdmin() 
                    || (request.auth.uid == userId && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['displayName', 'lastLogin']));

      // Delete: Only Admins
      allow delete: if isAdmin();
    }

    // STUDENTS: The raw student data (Collection-only, no Auth required)
    match /students/{studentId} {
      // Public read for the Landing Page lookup (Get only)
      allow get: if true;
      
      // Admins and Homeroom can read (list/get)
      allow read: if isAdmin() || isHomeroom();
      
      // Only Admins can write
      allow write: if isAdmin();
    }

    // FEES: Contribution fees
    match /fees/{feeId} {
      // Public read (so students can see what they owe)
      allow read: if true;

      // Admins can manage fees
      allow create, update, delete: if isAdmin();
    }

    // PAYMENTS: Transaction records
    match /payments/{paymentId} {
      // Public read (so students can see their history)
      allow read: if true;

      // Admins can manage payments
      // Homeroom can create and update (for collecting fees)
      allow create, update: if isAdmin() || isHomeroom();
      allow delete: if isAdmin();
    }

    // HOMEROOMS: (Legacy/Future use)
    match /homerooms/{homeroomId} {
      allow read, write: if isAdmin();
    }
  }
}

